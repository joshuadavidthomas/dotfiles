#!/usr/bin/bash

set -euo pipefail

cd "$HOME" || exit

# permissions
chmod 700 "$HOME/.cache" "$HOME/.config"

# sparse checkout
yadm gitconfig core.sparseCheckout true
yadm sparse-checkout set '/*' '!README.md' '!LICENSE' '!.github/workflows/*'

# install flatpaks
if command -v flatpak &>/dev/null && [ -f "$HOME/.flatpaks" ]; then
        xargs -a "$HOME/.flatpaks" -r flatpak --system -y install --or-update
fi

# install homebrew tools
if command -v brew &>/dev/null && [ -f "$HOME/.Brewfile" ]; then
        brew bundle --global
fi

# install programming languages
if command -v mise &>/dev/null; then
        mise install
fi

if command -v nvim &>/dev/null; then
        # force install of Neovim plugins
        nvim --headless -u "$HOME/.config/nvim/init.lua" -c "Lazy! sync" +qa
        # lazygit's native theme depends on the autogenerated one
        # provided by Lazyvim, so open lazygit in neovim headless mode
        # to make sure it's generated
        nvim --headless -u "$HOME/.config/nvim/init.lua" -c ":lua require('lazyvim.util.lazygit').open()" +qa
        # TODO: install language providers
        # python: activate venv and install requirements.txt in ~/.config/nvim
        # perl: cpanm -n Neovim::Ext
        #   - I am not, nor have never been a perl programmer, but `:checkhealth` within Neovim
        #     complains about this, so there must be some reason to do this (nvim internals, plugins,
        #     whatever..) -- doesn't really affect me but doesn't hurt to do
fi

# TODO: add notes about post bootstrap process
# - login to self-hosted atuin sync server
# - install MonoLisa font
#   - https://www.monolisa.dev/api/fonts/v2/download?version=2.015&format=ttf&suffix=&freeze=ss04&freeze=zero&freeze=ss02&freeze=ss07&freeze=ss11&freeze=ss13&freeze=ss15&freeze=ss16
