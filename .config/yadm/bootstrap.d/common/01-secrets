#!/usr/bin/env bash

set -oue pipefail

source "$(dirname "$0")/../utils"

# Ensure gum is installed first
if ! command -v gum &>/dev/null; then
        echo "Installing gum for interactive prompts..."
        distro=$(get_distro)
        case "$distro" in
        arch)
                yay -S --noconfirm gum
                ;;
        aurora|fedora)
                if command -v brew &>/dev/null; then
                        brew install gum
                else
                        sudo dnf copr enable -y charmbracelet/charm
                        sudo dnf install -y gum
                fi
                ;;
        *)
                echo "Warning: Cannot auto-install gum for distro: $distro"
                echo "Please install gum manually: https://github.com/charmbracelet/gum"
                exit 1
                ;;
        esac
fi

ENV_FILE="$HOME/.env"
touch "$ENV_FILE"
chmod 600 "$ENV_FILE"

key_exists() {
        local key="$1"
        grep -q "^${key}=" "$ENV_FILE"
}

echo
gum style --foreground="#00d1b2" --bold --border double --padding "1 2" "Secret Collection"
echo "Collecting secrets for unattended bootstrap..."
echo

# Prompt for Wakatime API key if not already set
if ! key_exists "WAKATIME_API_KEY"; then
        gum style --foreground="#00d1b2" --bold "Wakatime Configuration"
        echo "Please enter your Wakatime API key (or press Enter to skip):"
        WAKATIME_API_KEY=$(gum input --placeholder "waka_xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" --width 60)

        if [[ -n "$WAKATIME_API_KEY" ]]; then
                echo "WAKATIME_API_KEY=$WAKATIME_API_KEY" >>"$ENV_FILE"
                echo "✓ Wakatime API key saved to ~/.env"
        else
                echo "⚠ Skipping Wakatime configuration"
        fi
else
        echo "✓ Wakatime API key already configured"
fi

echo

# Check if Atuin is already logged in
if command -v atuin &>/dev/null && atuin status &>/dev/null && atuin status 2>&1 | grep -q "Username:"; then
        echo "✓ Atuin already logged in"
else
        gum style --foreground="#00d1b2" --bold "Atuin Configuration"
        echo "Please enter your Atuin credentials (or press Enter to skip):"
        echo "Note: These will only be used during this bootstrap session"

        ATUIN_PASSWORD=$(gum input --placeholder "Atuin password" --password --width 60)

        if [[ -n "$ATUIN_PASSWORD" ]]; then
                ATUIN_KEY=$(gum input --placeholder "Atuin key" --width 60)

                if [[ -n "$ATUIN_KEY" ]]; then
                        export ATUIN_PASSWORD
                        export ATUIN_KEY
                        echo "✓ Atuin credentials collected (in memory only)"
                else
                        echo "⚠ Atuin key not provided, skipping Atuin configuration"
                fi
        else
                echo "⚠ Skipping Atuin configuration"
        fi
fi

echo
echo "✓ Secret collection complete"
echo
